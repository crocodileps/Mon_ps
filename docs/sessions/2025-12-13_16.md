# Session 2025-12-13 #16 - GoalscorerCalculator + UnifiedBrain V2.8

## Contexte
Suite à l'audit des données goalscorer (Session #15), implémentation de:
1. Transformation des données brutes → profils buteurs
2. UnifiedBrain V2.8 avec Team Totals (+6 marchés)
3. GoalscorerCalculator pour Anytime/First/Last Goalscorer

## Réalisé

### 1. Transformation Données Goalscorer
Script `transform_goalscorer_data.py` qui convertit `all_shots_against_2025.json`:
- 1,869 buts → 876 profils joueurs
- Calcul `is_first_goal`, `is_last_goal` par match
- Timing distribution (0-15', 16-30', etc.)
- Timing profiles: EARLY_BIRD, CLUTCH, DIESEL, CONSISTENT

**Fichiers générés:**
- `data/goals/all_goals_detailed_2025.json` (985 KB)
- `data/goals/goalscorer_profiles_2025.json` (966 KB)
- `data/goals/first_goalscorer_stats.json` (85 KB)
- `data/goals/transformation_summary.json`

### 2. UnifiedBrain V2.8 - Team Totals
+6 nouveaux marchés:
- `home_over_05`, `home_over_15`, `home_over_25`
- `away_over_05`, `away_over_15`, `away_over_25`

**Exemple Liverpool (1.81 xG) vs Man City (1.96 xG):**
- Home O0.5: 83.6%, O1.5: 53.9%, O2.5: 27.1%
- Away O0.5: 86.0%, O1.5: 58.4%, O2.5: 31.4%

### 3. GoalscorerCalculator V1.0
Marchés:
- **Anytime GS**: P = 1 - e^(-λ) où λ = goals_per_90 × minutes_expected
- **First GS**: P = P(Team 1st) × P(Player|Team) × timing_adj
- **Last GS**: P × clutch_factor (basé sur pct_76_90)

**Exemple Liverpool vs Man City:**
```
ANYTIME TOP 3:
  1. Haaland (Man City) - 87.8%
  2. Foden (Man City)   - 87.8%
  3. Ekitike (Liverpool) - 80.0%

FIRST GS TOP 3:
  1. Gravenberch (Liverpool) - 40.4%
  2. Haaland (Man City)      - 29.7%
  3. Ekitike (Liverpool)     - 18.7%
```

## Fichiers touchés

### Créés
- `scripts/transform_goalscorer_data.py` - Transformation données
- `quantum_core/brain/team_totals.py` - TeamTotalsCalculator
- `quantum_core/brain/goalscorer.py` - GoalscorerCalculator (683 lignes)
- `data/goals/*.json` - Données goalscorer transformées

### Modifiés
- `quantum_core/brain/models.py` - +6 MarketTypes, +6 champs, V2.8
- `quantum_core/brain/unified_brain.py` - +TeamTotals, VERSION 2.8.0
- `quantum_core/brain/__init__.py` - +exports TeamTotals et Goalscorer

## Problèmes résolus

### 1. Team name incorrects dans transformation
**Problème:** `all_shots_against` contient les tirs CONTRE une équipe, donc `team_name` était l'équipe qui défend, pas celle qui marque.
**Solution:** Inversé la logique pour utiliser h_team/a_team correctement.

### 2. goals_per_90 = 0 pour tous les joueurs
**Problème:** L'enrichissement FBRef n'a pas fonctionné (noms différents entre Understat et FBRef).
**Solution:** Estimation de goals_per_90 à partir des données brutes:
```python
if goals_per_90 <= 0 and total_goals > 0:
    estimated_minutes = matches_with_goal * 70
    goals_per_90 = (total_goals / estimated_minutes) * 90
```

## Commits
```
12aab77 feat(brain): UnifiedBrain V2.8 - Team Totals +6 marchés (99 total)
80e0794 feat(brain): GoalscorerCalculator - Anytime/First/Last GS markets
```

## En cours / À faire
- [ ] Calibrer les probabilités goalscorer (actuellement un peu élevées)
- [ ] Améliorer matching Understat ↔ FBRef pour enrichissement
- [ ] API FastAPI pour exposer UnifiedBrain + GoalscorerCalculator
- [ ] Backtest sur données historiques

## Notes techniques

### Usage GoalscorerCalculator
```python
from quantum_core.brain import get_goalscorer_calculator, get_unified_brain

# Obtenir xG via UnifiedBrain
brain = get_unified_brain()
p = brain.analyze_match("Liverpool", "Man City")

# Analyse goalscorer
gs = get_goalscorer_calculator()
analysis = gs.analyze_match(
    "Liverpool", "Manchester City",
    p.expected_home_goals, p.expected_away_goals
)

# Accès aux rankings
print(analysis.anytime_rankings[0].player_name)
print(analysis.first_gs_rankings[0].first_gs_prob)
```

### Timing Adjustments
```python
TIMING_ADJUSTMENTS = {
    "EARLY_BIRD": {"first": 1.3, "last": 0.7},
    "CLUTCH": {"first": 0.7, "last": 1.4},
    "DIESEL": {"first": 0.8, "last": 1.2},
    "CONSISTENT": {"first": 1.0, "last": 1.0},
}
```

### Top First Goalscorers (Données)
- Haaland: 8 first goals (53.3% rate, avg 24.9')
- Mbappé: 7 first goals (43.8% rate, avg 31.6')
- Lautaro: 5 first goals (71.4% rate, avg 18.6')
