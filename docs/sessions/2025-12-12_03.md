# Session 2025-12-12 #03 - DNA Narrative Generator V1.0 + Audit Data Quality

## Contexte
Continuation de la session precedente. Creation du DNA Narrative Generator avec 15 axes continus pour remplacer les 12 profils tactiques discretes. Audit complet de la qualite des donnees.

## Realise

### 1. Creation DNA Narrative Generator V1.0
- Generateur avec 15 axes continus (0-100) au lieu de profils discrets
- Forces/Faiblesses extraites automatiquement (axes >65 / <35)
- Marches exploitables derives des axes
- Identites narratives uniques par equipe

### 2. API Router Team DNA
- 6 endpoints crees:
  - GET `/api/v1/team-dna/{team}` - Profil complet
  - GET `/api/v1/team-dna/{team}/axes` - 15 axes
  - GET `/api/v1/team-dna/{team}/markets` - Marches exploitables
  - GET `/api/v1/team-dna/compare/{a}/{b}` - Comparaison
  - GET `/api/v1/team-dna/search` - Recherche par criteres
  - GET `/api/v1/team-dna/teams` - Liste 96 equipes

### 3. Audit Hedge Fund - 5 Red Flags
Identification et correction de 5 problemes critiques:

| Red Flag | Avant | Apres |
|----------|-------|-------|
| pressing_intensity = 0 | 20/20 equipes | 2/20 equipes |
| transition_defense = 0 | 20/20 equipes | 0/20 equipes |
| Liverpool "possession" | FAUX | CORRIGE |
| Atletico GK = 100 | Constant | 61 (realiste) |
| Man City possession | 63 | PROBLEME DONNEES |

### 4. Correction Data Paths
Chemins de donnees corriges dans `_calculate_axes()`:

| Axe | Ancien chemin | Nouveau chemin |
|-----|---------------|----------------|
| pressing_intensity | tactical.pressing_intensity (texte) | context.history.ppda (inverse) |
| diesel_factor | temporal.ga_by_period | defense.percentiles.late_prop |
| home_dominance | record.home_ppg | defense.percentiles.home/away |
| goalkeeper_reliability | defense.xga/ga | defensive_line.goalkeeper.gk_percentile |
| verticality | defensive_style | tactical.progressive_passes |
| clinical_finishing | defense.xg/goals | fbref.goals/xg |

### 5. Audit Data Quality
Decouverte de problemes dans les donnees sources:

**Possession incorrecte (6/16 equipes erreur >5%):**
- Man City: 57.1% (donnees) vs 64.5% (realite) = -7.4%
- Liverpool: 61.1% (donnees) vs 54.0% (realite) = +7.1%
- PSG: 70.0% (donnees) vs 58.0% (realite) = +12%

**Anomalie detectee:**
- Man City classe "LOW_BLOCK" dans Understat (FAUX!)
- PPDA Man City = 13.38 (eleve = peu pressant) - semble incorrect

## Fichiers touches

### Crees
- `quantum/profilers/dna_narrative_generator.py` (~900 lignes) - Generateur 15 axes
- `api/routers/team_dna.py` (~490 lignes) - API endpoints
- `/home/Mon_ps/docs/sessions/2025-12-12_03.md` - Cette session

### Modifies
- `api/main.py` - Ajout team_dna router (+10 lignes)

## Problemes resolus

### 1. 8 axes constants (StdDev = 0)
**Probleme:** pressing_intensity, transition_defense, etc. tous a 0 ou valeur fixe
**Solution:** Corriger les chemins de donnees pour lire context.history.ppda, defense.percentiles.*, etc.
**Resultat:** 11/15 axes maintenant discriminants (StdDev > 15)

### 2. Identites incoherentes
**Probleme:** Liverpool "etouffe par la possession" alors que c'est GEGENPRESS
**Solution:** pressing_intensity maintenant calcule depuis PPDA (inverse)
**Resultat:** Liverpool pressing=71, diesel=74 (coherent)

### 3. GK reliability constant = 100
**Probleme:** Toutes les equipes avaient goalkeeper_reliability = 100
**Solution:** Utiliser defensive_line.goalkeeper.gk_percentile
**Resultat:** Atletico = 61, Liverpool = 12 (realistes)

## En cours / A faire

- [ ] **Corriger diesel_factor** (StdDev = 6.1, trop faible) - Utiliser donnees offensives
- [ ] **Ameliorer identites** - 3/5 equipes ont identite qui ne reflete pas top axis
- [ ] **Rafraichir donnees FBRef** - Man City possession 57.1% est incorrect
- [ ] **Ajuster normalisation PPDA** - Equipes allemandes sous-evaluees (6,18 au lieu de 6,16)
- [ ] **Investiguer anomalie Man City** - LOW_BLOCK dans Understat est une erreur

## Notes techniques

### Distribution des 15 axes (apres correction)
```
Axe                    StdDev  Verdict
────────────────────────────────────────
home_dominance         42.8    EXCELLENT
transition_defense     31.2    EXCELLENT
goalkeeper_reliability 30.4    EXCELLENT
clutch_factor          26.3    TRES BON
clinical_finishing     25.3    TRES BON
pressing_intensity     24.3    CORRIGE!
verticality            21.3    BON
first_half_intensity   20.3    BON
possession_control     18.7    BON
diesel_factor          6.1     A AMELIORER
```

### Chemins de donnees critiques decouverts
```python
# Possession
tactical.possession_pct  # FBRef source
fbref.possession_pct     # Meme valeur

# Pressing
context.history.ppda           # Understat (lower = more pressing)
context.history.pressing_style # Understat (peut etre incorrect!)
tactical.pressing_intensity    # FBRef (texte: HIGH/LOW)

# Timing
defense.percentiles.late       # Resist late goals
defense.percentiles.early      # Resist early goals
defense.timing_profile         # STRONG_START, FADES_LATE, etc.

# GK
defensive_line.goalkeeper.gk_percentile    # 0-100
defensive_line.goalkeeper.gk_overperform   # -20 to +20
```

### Validation contre realite footballistique
```
Liverpool:    pressing=71, diesel=74    COHERENT
Man City:     possession=63             DONNEES INCORRECTES
Atletico:     defensive_compactness=79  COHERENT
Brighton:     pressing=68               COHERENT
Burnley:      home_dominance=100        COHERENT
```

## Commandes utiles pour reprendre
```bash
# Tester le generateur
python3 quantum/profilers/dna_narrative_generator.py

# Tester l'API
python3 api/routers/team_dna.py

# Verifier les axes
python3 -c "
from quantum.profilers.dna_narrative_generator import DNANarrativeGenerator
gen = DNANarrativeGenerator()
print(gen.generate_profile('Liverpool'))
"
```
