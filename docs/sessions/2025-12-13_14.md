# Session 2025-12-13 #14 - UnifiedBrain V2.7 (93 Marches) + Audit Team Totals

## Contexte
Continuation de l'extension du UnifiedBrain:
- V2.6 (85 marches) etait complete
- Objectif: Ajouter 8 nouveaux marches pour V2.7 (93 marches)
- Puis audit des donnees pour Team Totals et First Goalscorer

## Realise

### 1. UnifiedBrain V2.7 - 93 Marches
Implementation de 3 nouveaux calculateurs:

**ScoreInBothHalvesCalculator** (+2 marches)
- `score_both_halves_yes`: Au moins 1 but dans chaque mi-temps
- `score_both_halves_no`: Pas de but dans au moins une mi-temps
- Formule: P(SIBH) = P(>=1 but HT) * P(>=1 but 2H) = (1-e^(-xg_ht)) * (1-e^(-xg_2h))

**CleanSheetCalculator** (+2 marches)
- `home_clean_sheet_yes`: Away marque 0 buts
- `away_clean_sheet_yes`: Home marque 0 buts
- Formule: P(Home CS) = e^(-away_xg)

**ToScoreInHalfCalculator** (+4 marches)
- `home_to_score_1h`: Home marque en 1ere mi-temps
- `home_to_score_2h`: Home marque en 2eme mi-temps
- `away_to_score_1h`: Away marque en 1ere mi-temps
- `away_to_score_2h`: Away marque en 2eme mi-temps
- Formule: P(Team score Half) = 1 - e^(-team_xg_half)

### 2. Audit Donnees pour Prochains Marches

**Team Totals - PRET:**
- expected_home_goals: disponible (ex: 1.805 Liverpool)
- expected_away_goals: disponible (ex: 1.965 Man City)
- PoissonCalculator: deja implemente

**First/Anytime Goalscorer - DONNEES PARTIELLES:**
- players_impact_dna.json: 2324 joueurs avec xG, goals, etc.
- all_goals_2025.json: vide (0 entrees)
- PostgreSQL match_goals: non accessible

## Fichiers touches

### Crees
- `quantum_core/brain/score_both_halves.py` - ScoreInBothHalvesCalculator
- `quantum_core/brain/clean_sheet.py` - CleanSheetCalculator
- `quantum_core/brain/to_score_half.py` - ToScoreInHalfCalculator

### Modifies
- `quantum_core/brain/models.py` - +8 MarketTypes, +8 MatchPrediction fields, V2.7
- `quantum_core/brain/__init__.py` - +3 exports, version 2.7.0
- `quantum_core/brain/unified_brain.py` - +3 calculateurs, 93 marches

## Commits
```
c139168 feat(brain): ScoreBothHalves + CleanSheet + ToScoreHalf - +8 marches (93 total)
```

## Tests effectues
```python
# Tous les tests passent
Version: 2.7.0
Markets: 93

1. ScoreInBothHalvesCalculator:
   xG=2.5: YES=50.5% | NO=49.5%

2. CleanSheetCalculator:
   Home xG=1.5, Away xG=1.2:
   Home CS: 30.1%
   Away CS: 22.3%

3. ToScoreInHalfCalculator:
   Home 1H: 49.1% | 2H: 56.2%
   Away 1H: 41.7% | 2H: 48.3%
```

## En cours / A faire
- [ ] Implementer TeamTotalsCalculator (+8 marches) -> V2.8 (101 marches)
- [ ] Marches Team Totals: Home/Away Over/Under 0.5, 1.5, 2.5
- [ ] First Goalscorer: Attendre donnees historiques buts

## Notes techniques

### Distribution mi-temps
```python
HT_RATIO = 0.45      # 45% des buts en 1ere mi-temps
SECOND_HALF_RATIO = 0.55  # 55% des buts en 2eme mi-temps
```

### Formules Poisson cles
```python
# Clean Sheet
P(Home CS) = e^(-away_xg)  # Away marque 0

# To Score in Half
P(Team score in Half) = 1 - e^(-team_xg_half)

# Score Both Halves
P(SIBH) = (1-e^(-xg_ht)) * (1-e^(-xg_2h))
```

### LIQUIDITY_TAX pour nouveaux marches
- Score Both Halves: 2.5%
- Clean Sheet: 2%
- To Score in Half: 2.5%

### Prochaine etape: TeamTotalsCalculator
Utiliser expected_home_goals et expected_away_goals (deja disponibles) pour calculer:
- Home Over/Under 0.5, 1.5, 2.5
- Away Over/Under 0.5, 1.5, 2.5
