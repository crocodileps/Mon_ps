# Session 2025-12-12_02 - Betting Profiles V2 (Defenders + Midfielders Sub-Roles)

## Contexte
Enrichissement des profils de paris avec double classification:
- **Defenders**: Structure simplifiée CENTRAL/WIDE avec sous-rôles
- **Midfielders**: Ajout de sous-rôles + correction seuils DM modernes

## Réalisé

### 1. Defender Betting Profiles V2
- Simplification structure: CENTRAL/FULLBACK/WINGBACK → CENTRAL/WIDE
- Sous-rôles CENTRAL: DOMINANT | BALL_PLAYING | STOPPER
- Sous-rôles WIDE: ATTACKING | BALANCED | DEFENSIVE | INVERTED
- Détection positions intelligente (D F S = attacking wingback comme Hakimi)
- Fallback stats-based pour positions ambiguës (DF, D S)

**Validation Stars Defenders: 6/7**
- ✅ Van Dijk → CENTRAL/DOMINANT
- ✅ Saliba → CENTRAL/BALL_PLAYING
- ✅ Dias → CENTRAL/BALL_PLAYING
- ✅ Robertson → WIDE/ATTACKING
- ✅ Hakimi → WIDE/ATTACKING (corrigé de INVERTED)
- ⚠️ Walker-Peters → WIDE/BALANCED (stats ambiguës)

### 2. Midfielder Betting Profiles V2
- Ajout MIDFIELDER_SUB_ROLE_CONFIG
- Nouvelle fonction classify_midfielder_sub_role()
- Modification meta: primary_role + sub_role + sub_role_confidence
- Seuils adaptés aux DM modernes (Rodri, Rice)

**Structure sous-rôles:**
```
SENTINELLE → ANCHOR / REGISTA
BOX_TO_BOX → DESTROYER / CARRIER / WORKHORSE
MENEUR → CLASSIC_10 / SHADOW_STRIKER / DEEP_LYING
```

**Validation Stars Midfielders: 7/9 primary correct**
- ✅ Rodri → SENTINELLE/REGISTA (corrigé de BOX_TO_BOX)
- ✅ Casemiro → SENTINELLE/ANCHOR
- ✅ Bruno Fernandes → MENEUR/CLASSIC_10
- ✅ Pedri → MENEUR/DEEP_LYING
- ✅ Bellingham → MENEUR/SHADOW_STRIKER
- ⚠️ Rice → MENEUR/DEEP_LYING (xA=0.208 = profil offensif)
- ⚠️ Barella → MENEUR/CLASSIC_10 (xA=0.297 = profil offensif)

### 3. Philosophie Validée
> "Les données dictent le profil, pas la réputation"

Rice et Barella sont classés MENEUR car leurs stats réelles reflètent leur impact betting - approche quantitative pure.

## Fichiers touchés

### Créés
- `scripts/generate_defender_betting_profiles.py` - Script complet 996 lignes
- `data/quantum_v2/defender_betting_profiles.json` - 1231 profils
- `scripts/generate_defender_betting_profiles.py.backup_v1` - Backup
- `scripts/generate_midfielder_betting_profiles.py.backup_v2` - Backup

### Modifiés
- `scripts/generate_midfielder_betting_profiles.py` - Ajout sub_roles + seuils DM modernes
- `data/quantum_v2/midfielder_betting_profiles.json` - 1610 profils enrichis

## Problèmes résolus

### Defender Profiles
1. **Hakimi classé CENTRAL** → Pattern "D F S" non détecté
   - Solution: Ajout `attacking_defender_patterns = ['D F', 'F D', 'D F S', 'F D S']`

2. **Hakimi classé INVERTED au lieu de ATTACKING** → Crosses élevées ignorées
   - Solution: Pénalités INVERTED si `crosses >= 2.5`

3. **Walker-Peters classé CENTRAL** → Seuils fallback trop stricts
   - Solution: Abaissement seuils (`crosses >= 1.5` ou `prog_carries >= 2.0`)

### Midfielder Profiles
1. **Rodri classé BOX_TO_BOX** → Seuils SENTINELLE trop stricts (tackles >= 2.0)
   - Solution: Nouveau scoring basé sur `defensive_actions` combiné + ball_recoveries

2. **Error NoneType avec impact** → `player.get('impact', {})` retournait None
   - Solution: `player.get('impact', {}) or {}`

## Distribution Finale

### Defenders (1231 profils)
| Primary Role | Count | % |
|-------------|-------|---|
| CENTRAL | 732 | 59.5% |
| WIDE | 499 | 40.5% |

### Midfielders (1610 profils)
| Primary Role | Count | % |
|-------------|-------|---|
| BOX_TO_BOX | 619 | 38.4% |
| MENEUR | 511 | 31.7% |
| SENTINELLE | 480 | 29.8% |

## Commits
```
740ad0a feat(midfielder): V2 Double classification (primary_role + sub_role)
db76c3b feat(betting): Defender Betting Profiles V2 - CENTRAL/WIDE Structure
```

## En cours / A faire
- [ ] Attacker Betting Profiles (script existe mais non finalisé)
- [ ] Goalkeeper Betting Profiles (data/goalkeeper_dna/goalkeeper_dna_v2.json existe)
- [ ] Validation sur plus de stars pour ajuster les seuils limites

## Notes techniques

### Patterns de détection position WIDE
```python
wide_indicators = ['RB', 'LB', 'R B', 'L B', 'D R', 'D L', 'WB', 'W B', 'FB']
attacking_defender_patterns = ['D F', 'F D', 'D F S', 'F D S']
```

### Calcul minutes_90 par inférence
```python
# Si time_played = 0, inférer depuis tackles / tackles_90
if minutes_90 == 0 and tackles_90 > 0:
    minutes_90 = tackles / tackles_90
```

### Scoring DM modernes (Rodri, Rice)
```python
defensive_actions = tackles + interceptions
if defensive_actions >= 2.3:
    sentinelle_score += 25
if ball_recoveries >= 5.5:
    sentinelle_score += 28
if progressive_passes >= 6.0 and defensive_actions >= 2.0:
    sentinelle_score += 15  # Bonus "Regista potential"
```

### Sub-role config structure
```python
MIDFIELDER_SUB_ROLE_CONFIG = {
    "SENTINELLE": {
        "ANCHOR": {...},
        "REGISTA": {...}
    },
    "BOX_TO_BOX": {
        "DESTROYER": {...},
        "CARRIER": {...},
        "WORKHORSE": {...}
    },
    "MENEUR": {
        "CLASSIC_10": {...},
        "SHADOW_STRIKER": {...},
        "DEEP_LYING": {...}
    }
}
```
